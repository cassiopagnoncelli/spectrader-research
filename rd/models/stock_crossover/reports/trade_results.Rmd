---
title: "Stock Crossover Trade Results"
author: "Research Team"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: show
    fig_width: 10
    fig_height: 6
params:
  dfsr: NULL
  posl: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center'
)

library(dplyr)
library(ggplot2)

# Get parameters
dfsr <- params$dfsr
posl <- params$posl
```

# Trade Results Summary

```{r summary}
cat(sprintf("Total Positions: %d\n", nrow(dfsr)))
cat(sprintf("Completed Trades: %d\n", sum(!is.na(dfsr$R))))
cat(sprintf("Open Positions: %d\n", sum(is.na(dfsr$R))))
```

---

# Kelly Criterion

```{r kelly}
# Kelly - sequential
f_star <- kelly_quantile(log(1 + dfsr$R), tau = .32)
pk <- plot_kelly_trades(dfsr$R, f_star, log.transform = FALSE)
print(pk)

cat(sprintf("\nKelly Optimal Fraction (f*): %.4f\n", f_star))
```

---

# Returns Distribution

```{r returns_dist}
# Returns distribution
plot_distribution(na.omit(dfsr$R), title = "Simple Returns distribution")
```

---

# Accuracy Analysis

## Take Profit Positions

```{r take_profit}
side <- "long"
accuracy <- exit_accuracy(dfsr, side = side)
accuracy_take_profit <- accuracy %>% filter(t < max(t))

cat("\n### Exit Metrics (Take Profit)\n")
exit_metrics(accuracy_take_profit, side)

cat("\n### Distribution Analysis (Take Profit)\n")
analyse_distribution(accuracy_take_profit$R, groups = c(0))
```

## Open Positions

```{r open_positions}
accuracy_open_positions <- accuracy %>% filter(t == max(t))

cat("\n### Exit Metrics (Open Positions)\n")
exit_metrics(accuracy_open_positions, side)

cat("\n### Distribution Analysis (Open Positions)\n")
analyse_distribution(accuracy_open_positions$R, groups = c(0))
```

## All Positions

```{r all_positions}
cat("\n### Exit Metrics (All)\n")
exit_metrics(accuracy, side)

cat("\n### Distribution Analysis (All)\n")
analyse_distribution(accuracy$R, groups = c(0))
```

---

# Sample Position Plots

To view sample position exit plots, change `n = 0` to a higher number in the code below:

```{r sample_plots, eval=FALSE}
# Inspect exits
dfsr %>%
  filter(t < max(t, na.rm = TRUE)) %>%
  slice_sample(n = 0) %>%  # Change n to view more samples
  pull(trade) %>%
  purrr::walk(~ plot_position_cohort_exit_qr(posl[[.x]], ylim = c(.8, 1.5)))
```

---

<div style="text-align: center; color: #6c757d; margin-top: 40px; padding: 20px; border-top: 1px solid #dee2e6;">
**Report Generated:** `r Sys.time()`
</div>
